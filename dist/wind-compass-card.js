console.info("%c WindCompassCard Loaded: V_0.1 ","color: white; background: #607d8b; font-weight: bold;");class t extends HTMLElement{constructor(){super(...arguments),this._bucketSize=5,this._bucketCount=72,this._warnMultiplier=.9,this._historyData=[],this._lastHistoryFetch=0,this._currentUnit="",this._maxSpeed=30,this._currentGust=0,this._limitRaffstore=0,this._limitRollo=0}set hass(t){if(!this.content){const t=document.createElement("ha-card");this.content=document.createElement("div"),this.content.style.padding="16px",this.content.style.display="flex",this.content.style.flexDirection="column",this.content.style.gap="16px",this.content.innerHTML='\n        <style>\n          .compass-container {\n            position: relative;\n            width: 100%;\n            height: 80px;\n            background: var(--secondary-background-color, rgba(0,0,0,0.2));\n            border-radius: 8px;\n            overflow: hidden;\n            border: 1px solid var(--divider-color, rgba(0,0,0,0.1));\n            touch-action: pan-y;\n            isolation: isolate; \n            z-index: 0; \n          }\n          \n          .compass-tape {\n            position: absolute;\n            top: 0;\n            left: 50%;\n            height: 100%;\n            display: flex;\n            align-items: center;\n            transition: transform 0.5s cubic-bezier(0.25, 1, 0.5, 1);\n            will-change: transform;\n            z-index: 1; \n          }\n          \n          /* Historien-Balken */\n          .hist-bar {\n            position: absolute;\n            bottom: 0;\n            border-top-left-radius: 1px;\n            border-top-right-radius: 1px;\n            pointer-events: none;\n            transform: none; \n            border-top: 2px solid; \n            box-sizing: border-box; \n            background: none; \n            transition: height 0.3s ease, border-color 0.3s ease;\n          }\n\n          .hist-fill {\n            position: absolute;\n            top: 0; left: 0; right: 0; bottom: 0;\n            transition: opacity 0.3s ease, background 0.3s ease;\n          }\n\n          .compass-tick {\n            position: absolute;\n            top: 0;\n            bottom: 0;\n            width: 1px;\n            background: var(--primary-text-color);\n            opacity: 0.2;\n            z-index: 2;\n          }\n          \n          .compass-label {\n            position: absolute;\n            top: 28px;\n            transform: translateX(-50%);\n            color: var(--primary-text-color);\n            font-weight: bold;\n            font-size: 14px;\n            font-family: var(--paper-font-body1_-_font-family, sans-serif);\n            z-index: 3;\n            text-shadow: 0 1px 2px var(--card-background-color);\n          }\n          \n          .compass-marker {\n            position: absolute;\n            left: 50%; \n            top: 0; \n            width: 0;\n            height: 0;\n            border-left: 8px solid transparent;\n            border-right: 8px solid transparent;\n            border-top: 10px solid var(--error-color, #ff3b30);\n            transform: translateX(-50%); \n            z-index: 5;\n            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.4));\n            transition: transform 0.5s cubic-bezier(0.25, 1, 0.5, 1);\n            will-change: transform;\n          }\n          \n          .compass-center-dot {\n             position: absolute;\n             left: 50%;\n             bottom: 0;\n             width: 0; \n             height: 0; \n             border-left: 6px solid transparent;\n             border-right: 6px solid transparent;\n             border-bottom: 8px solid var(--primary-text-color);\n             transform: translateX(-50%);\n             opacity: 0.8;\n             z-index: 4;\n          }\n\n          .speed-container {\n            display: flex;\n            flex-direction: column;\n            gap: 6px;\n          }\n\n          .speed-bar-bg {\n            position: relative;\n            width: 100%;\n            height: 8px;\n            background: var(--secondary-background-color, rgba(0,0,0,0.1));\n            border-radius: 4px;\n            overflow: visible; \n            isolation: isolate;\n            margin-top: 5px; \n            margin-bottom: 5px; \n          }\n\n          .speed-bar-gust {\n            position: absolute;\n            top: 0; left: 0; bottom: 0;\n            background: var(--accent-color, var(--primary-color, #2196F3));\n            opacity: 0.3;\n            width: 0%;\n            transition: width 0.5s ease-out;\n            z-index: 1;\n            border-radius: 4px;\n          }\n\n          .speed-bar-fill {\n            position: absolute;\n            top: 0; left: 0; bottom: 0;\n            background: var(--accent-color, var(--primary-color, #2196F3));\n            width: 0%;\n            transition: width 0.5s ease-out;\n            box-shadow: 0 0 10px var(--accent-color, transparent);\n            z-index: 2;\n            border-radius: 4px;\n          }\n\n          .limit-marker {\n            position: absolute;\n            top: -4px; \n            bottom: -4px; \n            width: 2px;\n            background-color: var(--primary-text-color);\n            z-index: 10;\n            box-shadow: 0 0 2px var(--card-background-color), 0 0 5px rgba(0,0,0,0.3);\n            display: none; \n            pointer-events: none;\n            opacity: 0.8;\n          }\n\n          .speed-text {\n            text-align: right;\n            color: var(--secondary-text-color);\n            font-size: 12px;\n            font-family: var(--paper-font-caption_-_font-family, sans-serif);\n            display: flex;\n            justify-content: flex-end;\n            gap: 8px;\n          }\n          \n          .speed-text span.faded {\n            opacity: 0.6;\n            font-size: 0.9em;\n          }\n        </style>\n\n        <div class="compass-container" id="container">\n          <div class="compass-center-dot"></div>\n          <div class="compass-marker" id="marker"></div>\n          <div class="compass-tape" id="tape"></div>\n        </div>\n\n        <div class="speed-container">\n          <div class="speed-bar-bg">\n            <div class="speed-bar-gust" id="gust-bar"></div>\n            <div class="speed-bar-fill" id="speed-bar"></div>\n            <div class="limit-marker" id="limit-raffstore" title="Raffstore Limit"></div>\n            <div class="limit-marker" id="limit-rollo" title="Rollo Limit"></div>\n          </div>\n          <div class="speed-text" id="speed-text">--</div>\n        </div>\n      ',t.appendChild(this.content),this.appendChild(t),this.resizeObserver=new ResizeObserver(()=>{this._updateDimensions(),this._updateVisuals()}),this.resizeObserver.observe(this.content),this._bucketSize=5,this._bucketCount=72,this._historyData=new Array(this._bucketCount).fill(null).map(()=>({duration:0,totalSpeed:0})),this._lastHistoryFetch=0}const e=this.config.direction_entity,n=this.config.instant_direction_entity||e,i=this.config.speed_entity,s=this.config.gust_entity,o=this.config.raffstore_limit_entity,r=this.config.rollo_limit_entity,a=this.config.max_speed||30;this._warnMultiplier=void 0!==this.config.warn_multiplier?parseFloat(String(this.config.warn_multiplier)):.9;let l=void 0!==this.config.bucket_size?parseInt(String(this.config.bucket_size)):5;for((isNaN(l)||l<1)&&(l=5),l>90&&(l=90);360%l!=0;)l++;const c=l;this._bucketSize!==c&&(console.info(`WindCompass: Bucket Size adjusted from config ${this.config.bucket_size||5} to ${c} to fit 360Â°.`),this._bucketSize=c,this._bucketCount=Math.floor(360/this._bucketSize),this._historyData=new Array(this._bucketCount).fill(null).map(()=>({duration:0,totalSpeed:0})),this._lastHistoryFetch=0);const d=t.states[e],p=t.states[n],h=t.states[i],u=s?t.states[s]:null;d&&(this._avgDeg=parseFloat(d.state)),p&&(this._instDeg=parseFloat(p.state)),h&&(this._currentSpeed=parseFloat(h.state),this._currentUnit=h.attributes.unit_of_measurement||"",this._maxSpeed=a),this._currentGust=u?parseFloat(u.state):0,this._limitRaffstore=0,this._limitRollo=0,o&&t.states[o]&&(this._limitRaffstore=parseFloat(t.states[o].state)),r&&t.states[r]&&(this._limitRollo=parseFloat(t.states[r].state));const f=Date.now();f-this._lastHistoryFetch>3e5&&(this._lastHistoryFetch=f,this._fetchHistory(t,e,i)),this._updateVisuals()}async _fetchHistory(t,e,n){const i=new Date,s=new Date(i.getTime()-864e5);try{const o=[e,n].join(","),r=await t.callApi("GET",`history/period/${s.toISOString()}?filter_entity_id=${o}&end_time=${i.toISOString()}&minimal_response`);if(r&&2===r.length){const t=r.find(t=>t.length>0&&t[0].entity_id===e),i=r.find(t=>t.length>0&&t[0].entity_id===n);t&&i&&this._processHistoryData(t,i)}}catch(t){console.error("History Error",t)}}_processHistoryData(t,e){const n=new Array(this._bucketCount).fill(null).map(()=>({duration:0,totalSpeed:0}));let i=0;for(let s=0;s<t.length-1;s++){const o=t[s],r=t[s+1],a=parseFloat(o.state);if(isNaN(a))continue;const l=new Date(o.last_changed).getTime(),c=(new Date(r.last_changed).getTime()-l)/1e3/60;for(;i<e.length-1&&new Date(e[i+1].last_changed).getTime()<=l;)i++;const d=e[i],p=parseFloat(d.state)||0,h=Math.floor(a%360/360*this._bucketCount);h>=0&&h<this._bucketCount&&(n[h].duration+=c,n[h].totalSpeed+=p*c)}this._historyData=n,this._updateDimensions()}_updateVisuals(){if(void 0===this._avgDeg||!this._pxPerDeg||!this.content)return;const t=this.content.querySelector("#tape");if(t){const e=this._avgDeg*this._pxPerDeg;t.style.transform=`translateX(-${e}px)`}const e=this.content.querySelector("#marker");if(e&&void 0!==this._instDeg){const t=(this._instDeg-this._avgDeg+540)%360-180;e.style.transform=`translateX(calc(-50% + ${t*this._pxPerDeg}px))`}const n=this.content.querySelector("#speed-bar"),i=this.content.querySelector("#gust-bar"),s=this.content.querySelector("#speed-text"),o=this.content.querySelector("#limit-raffstore"),r=this.content.querySelector("#limit-rollo");if(void 0!==this._currentSpeed){let t=this._currentSpeed/this._maxSpeed*100;t>100&&(t=100),n&&(n.style.width=`${t}%`);let e=this._currentGust/this._maxSpeed*100;if(e>100&&(e=100),i&&(i.style.width=`${e}%`),s){let t=`<span>${this._currentSpeed} ${this._currentUnit}</span>`;this._currentGust>0&&(t+=`<span class="faded">(Max ${this._currentGust})</span>`),s.innerHTML=t}if(o)if(this._limitRaffstore>0){let t=this._limitRaffstore/this._maxSpeed*100;t>100&&(t=100),o.style.left=`${t}%`,o.style.display="block"}else o.style.display="none";if(r)if(this._limitRollo>0){let t=this._limitRollo/this._maxSpeed*100;t>100&&(t=100),r.style.left=`${t}%`,r.style.display="block"}else r.style.display="none"}}_updateDimensions(){if(!this.content)return;const t=this.content.querySelector("#container");if(!t)return;const e=t.offsetWidth;0!==e&&(this._pxPerDeg=e/360,this._buildTape())}_buildTape(){if(!this.content||!this._pxPerDeg)return;const t=this.content.querySelector("#tape");if(!t)return;t.innerHTML="";const e=[];this._limitRaffstore>0&&e.push(this._limitRaffstore),this._limitRollo>0&&e.push(this._limitRollo);let n=null;e.length>0&&(n=Math.min(...e));const i=n?n*this._warnMultiplier:null;let s=0,o=0;this._historyData.forEach(t=>{if(t.duration>0){t.duration>s&&(s=t.duration);const e=t.totalSpeed/t.duration;e>o&&(o=e)}}),0===s&&(s=1),0===o&&(o=1);const r=this._bucketSize*this._pxPerDeg,a=Math.max(1,r-2);for(let e=-180;e<=540;e+=this._bucketSize){const n=e*this._pxPerDeg,r=(e%360+360)%360,l=Math.floor(r/this._bucketSize);if(l>=0&&l<this._bucketCount){const e=this._historyData[l];if(e&&e.duration>0){const r=e.totalSpeed/e.duration;let l=!1;null!==i&&r>=i&&(l=!0);const c=l?"var(--error-color, #ff3b30)":"var(--accent-color, var(--primary-color))",d=document.createElement("div");d.className="hist-bar";const p=r/o*100;d.style.height=.6*p+"%",d.style.left=`${n+1}px`,d.style.width=`${a}px`,d.style.borderTopColor=c;const h=document.createElement("div");if(h.className="hist-fill",h.style.background=`linear-gradient(to top, transparent, ${c})`,l)h.style.opacity="1.0";else{const t=e.duration/s;h.style.opacity=String(.1+.9*t)}d.appendChild(h),t.appendChild(d)}}const c=document.createElement("div");c.className="compass-tick",c.style.left=`${n}px`;let d=!1;if(r%90==0){c.style.height="100%",c.style.opacity="0.5";const e=document.createElement("div");e.className="compass-label";let i="";0===r?i="N":90===r?i="O":180===r?i="S":270===r&&(i="W"),e.innerText=i,e.style.left=`${n}px`,t.appendChild(e),d=!0}else r%45==0?(c.style.height="100%",c.style.opacity="0.3",d=!0):r%15==0&&(c.style.height="10px",c.style.top="25px",d=!0);d&&t.appendChild(c)}}setConfig(t){if(!t.direction_entity)throw new Error("direction_entity is required");if(!t.speed_entity)throw new Error("speed_entity is required");this.config=t}getCardSize(){return 3}}customElements.define("wind-compass-card",t),window.customCards=window.customCards||[],window.customCards.push({type:"wind-compass-card",name:"Wind Compass Card",preview:!0,description:"Professional wind direction compass card"});
//# sourceMappingURL=wind-compass-card.js.map
